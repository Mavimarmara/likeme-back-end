// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// CORE MODELS - Person and User Management
// ============================================

model Person {
  id                   String    @id @default(uuid())
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  deletedAt            DateTime? @map("deleted_at")
  nationalRegistration String?   @map("national_registration") // CPF, RG, etc
  firstName            String    @map("first_name")
  lastName             String    @map("last_name")
  surname              String?
  birthdate            DateTime?

  // Relations (inverse - apenas para validação Prisma, usar tabelas de relacionamento próprias)
  contacts PersonContact[] @relation("PersonContacts")
  user     User?           @relation("PersonUser")

  @@index([nationalRegistration])
  @@map("person")
}

model PersonContact {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  personId  String    @map("person_id")
  type      String // email, phone, whatsapp, etc
  value     String

  // Relations
  person Person @relation("PersonContacts", fields: [personId], references: [id], onDelete: Cascade)

  @@index([personId])
  @@index([type])
  @@map("person_contact")
}

model User {
  id               String    @id @default(uuid())
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  deletedAt        DateTime? @map("deleted_at")
  personId         String    @unique @map("person_id")
  username         String?   @unique
  password         String
  avatar           String?
  isActive         Boolean   @default(true) @map("is_active")
  socialPlusUserId String?   @unique @map("social_plus_user_id")

  // Relations
  person             Person                  @relation("PersonUser", fields: [personId], references: [id], onDelete: Cascade)
  // Relations (inverse - apenas para validação Prisma)
  roleGroups         RoleGroupUser[]         @relation("UserRoleGroups")
  personalObjectives UserPersonalObjective[] @relation("UserPersonalObjectives")
  communities        CommunityMember[]       @relation("UserCommunities")
  createdCommunities Community[]             @relation("UserCreatedCommunities")
  orders             Order[]                 @relation("UserOrders")
  advertiser         Advertiser?             @relation("UserAdvertiser")
  activities         Activity[]              @relation("UserActivities")
  products           Product[]               @relation("UserProducts")
  anamneseAnswers    AnamneseUserAnswer[]    @relation("UserAnamneseAnswers")

  @@index([personId])
  @@index([username])
  @@index([socialPlusUserId])
  @@map("user")
}

model PersonalObjective {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  name        String    @unique
  description String?
  order       Int? // Para ordenação dos objetivos

  // Relations (inverse - apenas para validação Prisma)
  users UserPersonalObjective[] @relation("PersonalObjectiveUsers")

  @@index([name])
  @@index([order])
  @@map("personal_objective")
}

model Role {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  name        String
  description String?

  // Relations (inverse - apenas para validação Prisma)
  roleGroups RoleGroupRole[] @relation("RoleRoleGroups")

  @@index([name])
  @@map("role")
}

model RoleGroup {
  id          String    @id // varchar, não auto-generated
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  name        String
  description String?

  // Relations (inverse - apenas para validação Prisma)
  roles RoleGroupRole[] @relation("RoleGroupRoles")
  users RoleGroupUser[] @relation("RoleGroupUsers")

  @@index([name])
  @@map("role_group")
}

model RoleGroupRole {
  roleGroupId String    @map("role_group_id")
  roleId      String    @map("role_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  roleGroup RoleGroup @relation("RoleGroupRoles", fields: [roleGroupId], references: [id], onDelete: Cascade)
  role      Role      @relation("RoleRoleGroups", fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleGroupId, roleId])
  @@map("role_group_role")
}

model RoleGroupUser {
  userId      String    @map("user_id")
  roleGroupId String    @map("role_group_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  user      User      @relation("UserRoleGroups", fields: [userId], references: [id], onDelete: Cascade)
  roleGroup RoleGroup @relation("RoleGroupUsers", fields: [roleGroupId], references: [id], onDelete: Cascade)

  @@id([userId, roleGroupId])
  @@map("role_group_user")
}

model UserPersonalObjective {
  userId      String    @map("user_id")
  objectiveId String    @map("objective_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  user      User              @relation("UserPersonalObjectives", fields: [userId], references: [id], onDelete: Cascade)
  objective PersonalObjective @relation("PersonalObjectiveUsers", fields: [objectiveId], references: [id], onDelete: Cascade)

  @@id([userId, objectiveId])
  @@map("user_personal_objective")
}

model Tip {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  title       String
  description String
  image       String
  order       Int?      @map("display_order")

  @@index([order])
  @@map("tip")
}

// ============================================
// SOCIAL.PLUS INTEGRATION MODELS
// ============================================

model Community {
  id                    String    @id @default(uuid())
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  deletedAt             DateTime? @map("deleted_at")
  name                  String
  description           String?
  type                  String // public, private, official, unofficial
  avatar                String?
  socialPlusCommunityId String?   @unique @map("social_plus_community_id")
  createdBy             String    @map("created_by") // userId

  // Relations
  creator User              @relation("UserCreatedCommunities", fields: [createdBy], references: [id])
  members CommunityMember[] @relation("CommunityMembers")

  @@index([socialPlusCommunityId])
  @@index([createdBy])
  @@index([type])
  @@map("community")
}

model CommunityMember {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  userId      String    @map("user_id")
  communityId String    @map("community_id")
  role        String    @default("member") // member, admin, moderator

  // Relations
  user      User      @relation("UserCommunities", fields: [userId], references: [id], onDelete: Cascade)
  community Community @relation("CommunityMembers", fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@index([userId])
  @@index([communityId])
  @@map("community_member")
}

// ============================================
// E-COMMERCE MODELS - Product and Order Management
// ============================================

model Product {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  name        String
  description String?
  sku         String?   @unique
  price       Decimal?  @db.Decimal(10, 2) // Optional when externalUrl is provided
  cost        Decimal?  @db.Decimal(10, 2)
  quantity    Int? // Optional when externalUrl is provided (Available stock)
  image       String?
  category    String? // amazon product, physical product, program
  brand       String?
  status      String    @default("active") // active, inactive, out_of_stock
  weight      Decimal?  @db.Decimal(10, 3) // in kg
  dimensions  String? // format: "LxHxW" (length x height x width)
  externalUrl String?   @map("external_url") // External URL for the product (e.g., Amazon product link)
  sellerId    String?   @map("seller_id") // User who sells this product

  // Relations
  seller     User?       @relation("UserProducts", fields: [sellerId], references: [id])
  orderItems OrderItem[] @relation("ProductOrderItems")
  ads        Ad[]        @relation("ProductAds")

  @@index([sku])
  @@index([name])
  @@index([category])
  @@index([status])
  @@index([quantity])
  @@index([externalUrl])
  @@index([sellerId])
  @@map("product")
}

model Order {
  id                   String    @id @default(uuid())
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  deletedAt            DateTime? @map("deleted_at")
  userId               String    @map("user_id")
  status               String    @default("pending") // pending, processing, shipped, delivered, cancelled
  total                Decimal   @db.Decimal(10, 2)
  subtotal             Decimal   @db.Decimal(10, 2)
  shippingCost         Decimal   @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  tax                  Decimal   @default(0) @db.Decimal(10, 2)
  shippingAddress      String?   @map("shipping_address")
  billingAddress       String?   @map("billing_address")
  notes                String?
  paymentMethod        String?   @map("payment_method")
  paymentStatus        String    @default("pending") @map("payment_status") // pending, paid, failed, refunded
  paymentTransactionId String?   @map("payment_transaction_id") // ID da transação Pagarme
  trackingNumber       String?   @map("tracking_number")

  // Relations
  user  User        @relation("UserOrders", fields: [userId], references: [id], onDelete: Cascade)
  items OrderItem[] @relation("OrderItems")

  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("order")
}

model OrderItem {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  orderId   String    @map("order_id")
  productId String    @map("product_id")
  quantity  Int
  unitPrice Decimal   @map("unit_price") @db.Decimal(10, 2) // Price at time of sale
  discount  Decimal   @default(0) @db.Decimal(10, 2)
  total     Decimal   @db.Decimal(10, 2)

  // Relations
  order   Order   @relation("OrderItems", fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation("ProductOrderItems", fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_item")
}

model Advertiser {
  id                 String    @id @default(uuid())
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  deletedAt          DateTime? @map("deleted_at")
  userId             String    @unique @map("user_id") // A user can be an advertiser
  name               String
  description        String?
  logo               String?
  contactEmail       String?   @map("contact_email")
  contactPhone       String?   @map("contact_phone")
  website            String?
  status             String    @default("active") // active, inactive, suspended
  pagarmeRecipientId String?   @unique @map("pagarme_recipient_id")

  // Relations
  user             User              @relation("UserAdvertiser", fields: [userId], references: [id], onDelete: Cascade)
  pagarmeRecipient PagarmeRecipient? @relation("AdvertiserPagarmeRecipient", fields: [pagarmeRecipientId], references: [recipientId])
  ads              Ad[]              @relation("AdvertiserAds")

  @@index([userId])
  @@index([status])
  @@index([pagarmeRecipientId])
  @@map("advertiser")
}

model Ad {
  id             String    @id @default(uuid())
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  deletedAt      DateTime? @map("deleted_at")
  advertiserId   String?   @map("advertiser_id")
  productId      String?   @map("product_id")
  startDate      DateTime? @map("start_date")
  endDate        DateTime? @map("end_date")
  status         String    @default("active") // active, inactive, expired
  targetAudience String?   @map("target_audience")

  // Relations
  advertiser Advertiser? @relation("AdvertiserAds", fields: [advertiserId], references: [id], onDelete: Cascade)
  product    Product?    @relation("ProductAds", fields: [productId], references: [id], onDelete: Cascade)

  @@index([advertiserId])
  @@index([productId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@map("ad")
}

// ============================================
// ACTIVITY MODELS - User Activities Management
// ============================================

model Activity {
  id              String    @id @default(uuid())
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")
  userId          String    @map("user_id")
  name            String
  type            String // task, event
  startDate       DateTime  @map("start_date")
  startTime       String?   @map("start_time")
  endDate         DateTime? @map("end_date")
  endTime         String?   @map("end_time")
  location        String?
  description     String?
  reminderEnabled Boolean   @default(false) @map("reminder_enabled")
  reminderOffset  String?   @map("reminder_offset") // e.g., "5 min before", "10 min after"

  // Relations
  user User @relation("UserActivities", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([startDate])
  @@index([endDate])
  @@map("activity")
}

// ============================================
// PAYMENT MODELS - Pagarme Recipients
// ============================================

model PagarmeRecipient {
  id               String    @id @default(uuid())
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  deletedAt        DateTime? @map("deleted_at")
  recipientId      String    @unique @map("recipient_id")
  name             String
  email            String
  document         String
  type             String
  status           String
  code             String?   @unique
  paymentMode      String?   @map("payment_mode")
  transferEnabled  Boolean?  @default(true) @map("transfer_enabled")
  transferInterval String?   @map("transfer_interval")
  transferDay      Int?      @map("transfer_day")
  isDefault        Boolean   @default(false) @map("is_default")

  // Relations
  advertisers Advertiser[] @relation("AdvertiserPagarmeRecipient")

  @@index([recipientId])
  @@index([code])
  @@index([isDefault])
  @@index([status])
  @@map("pagarme_recipient")
}

// ============================================
// ANAMNESE MODELS - Clinical Anamnesis with i18n
// ============================================

enum QuestionType {
  single_choice
  multiple_choice
  text
  number
}

model AnamneseQuestionConcept {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Identificador lógico único da pergunta
  key String @unique

  // Tipo de resposta esperada
  type QuestionType

  // Relações
  texts         AnamneseQuestionText[]
  answerOptions AnamneseAnswerOption[]
  userAnswers   AnamneseUserAnswer[]

  @@index([key])
  @@index([type])
  @@map("anamnese_question_concept")
}

model AnamneseQuestionText {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  questionConceptId String @map("question_concept_id")

  // Locale (ex: "pt-BR", "en-US")
  locale String

  // Texto exibido da pergunta
  value String

  // Relações
  questionConcept AnamneseQuestionConcept @relation(fields: [questionConceptId], references: [id], onDelete: Cascade)

  @@unique([questionConceptId, locale])
  @@index([questionConceptId])
  @@index([locale])
  @@map("anamnese_question_text")
}

model AnamneseAnswerOption {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  questionConceptId String @map("question_concept_id")

  // Identificador lógico da opção (yes, no, low, high, grave, moderado, etc)
  key String

  // Ordem de exibição
  order Int @default(0)

  // Relações
  questionConcept AnamneseQuestionConcept    @relation(fields: [questionConceptId], references: [id], onDelete: Cascade)
  texts           AnamneseAnswerOptionText[]
  userAnswers     AnamneseUserAnswer[]

  @@unique([questionConceptId, key])
  @@index([questionConceptId])
  @@index([key])
  @@index([order])
  @@map("anamnese_answer_option")
}

model AnamneseAnswerOptionText {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  answerOptionId String @map("answer_option_id")

  // Locale (ex: "pt-BR", "en-US")
  locale String

  // Texto exibido da opção
  value String

  // Relações
  answerOption AnamneseAnswerOption @relation(fields: [answerOptionId], references: [id], onDelete: Cascade)

  @@unique([answerOptionId, locale])
  @@index([answerOptionId])
  @@index([locale])
  @@map("anamnese_answer_option_text")
}

model AnamneseUserAnswer {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // User ID (string ou uuid conforme necessário)
  userId String @map("user_id")

  questionConceptId String @map("question_concept_id")

  // Opção escolhida (nullable para perguntas abertas)
  answerOptionId String? @map("answer_option_id")

  // Resposta em texto (nullable para perguntas de escolha)
  answerText String? @map("answer_text")

  // Relações
  user            User                    @relation("UserAnamneseAnswers", fields: [userId], references: [id], onDelete: Cascade)
  questionConcept AnamneseQuestionConcept @relation(fields: [questionConceptId], references: [id], onDelete: Cascade)
  answerOption    AnamneseAnswerOption?   @relation(fields: [answerOptionId], references: [id], onDelete: SetNull)

  @@unique([userId, questionConceptId])
  @@index([userId])
  @@index([questionConceptId])
  @@index([answerOptionId])
  @@index([createdAt])
  @@map("anamnese_user_answer")
}
