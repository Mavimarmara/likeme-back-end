// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// CORE MODELS - Person and User Management
// ============================================

model Person {
  id                   String    @id @default(uuid())
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  deletedAt            DateTime? @map("deleted_at")
  nationalRegistration String?   @map("national_registration") // CPF, RG, etc
  firstName            String    @map("first_name")
  lastName             String    @map("last_name")
  surname              String?
  birthdate            DateTime?

  // Relations (inverse - apenas para validação Prisma, usar tabelas de relacionamento próprias)
  contacts PersonContact[] @relation("PersonContacts")
  user     User?           @relation("PersonUser")

  @@index([nationalRegistration])
  @@map("person")
}

model PersonContact {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  personId  String    @map("person_id")
  type      String // email, phone, whatsapp, etc
  value     String

  // Relations
  person Person @relation("PersonContacts", fields: [personId], references: [id], onDelete: Cascade)

  @@index([personId])
  @@index([type])
  @@map("person_contact")
}

model User {
  id                    String    @id @default(uuid())
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  deletedAt             DateTime? @map("deleted_at")
  personId              String    @unique @map("person_id")
  username              String?   @unique
  password              String
  salt                  String?
  avatar                String?
  isActive            Boolean  @default(true) @map("is_active")
  socialPlusUserId    String?  @unique @map("social_plus_user_id")

  // Relations
  person             Person                  @relation("PersonUser", fields: [personId], references: [id], onDelete: Cascade)
  // Relations (inverse - apenas para validação Prisma)
  roleGroups         RoleGroupUser[]         @relation("UserRoleGroups")
  personalObjectives UserPersonalObjective[] @relation("UserPersonalObjectives")
  communities        CommunityMember[]       @relation("UserCommunities")
  createdCommunities Community[]             @relation("UserCreatedCommunities")
  orders             Order[]                 @relation("UserOrders")
  advertiser         Advertiser?             @relation("UserAdvertiser")

  @@index([personId])
  @@index([username])
  @@index([socialPlusUserId])
  @@map("user")
}

model PersonalObjective {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  name        String    @unique
  description String?
  order       Int? // Para ordenação dos objetivos

  // Relations (inverse - apenas para validação Prisma)
  users UserPersonalObjective[] @relation("PersonalObjectiveUsers")

  @@index([name])
  @@index([order])
  @@map("personal_objective")
}

model Role {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  name        String
  description String?

  // Relations (inverse - apenas para validação Prisma)
  roleGroups RoleGroupRole[] @relation("RoleRoleGroups")

  @@index([name])
  @@map("role")
}

model RoleGroup {
  id          String    @id // varchar, não auto-generated
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  name        String
  description String?

  // Relations (inverse - apenas para validação Prisma)
  roles RoleGroupRole[] @relation("RoleGroupRoles")
  users RoleGroupUser[] @relation("RoleGroupUsers")

  @@index([name])
  @@map("role_group")
}

model RoleGroupRole {
  roleGroupId String    @map("role_group_id")
  roleId      String    @map("role_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  roleGroup RoleGroup @relation("RoleGroupRoles", fields: [roleGroupId], references: [id], onDelete: Cascade)
  role      Role      @relation("RoleRoleGroups", fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleGroupId, roleId])
  @@map("role_group_role")
}

model RoleGroupUser {
  userId      String    @map("user_id")
  roleGroupId String    @map("role_group_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  user      User      @relation("UserRoleGroups", fields: [userId], references: [id], onDelete: Cascade)
  roleGroup RoleGroup @relation("RoleGroupUsers", fields: [roleGroupId], references: [id], onDelete: Cascade)

  @@id([userId, roleGroupId])
  @@map("role_group_user")
}

model UserPersonalObjective {
  userId      String    @map("user_id")
  objectiveId String    @map("objective_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  user      User              @relation("UserPersonalObjectives", fields: [userId], references: [id], onDelete: Cascade)
  objective PersonalObjective @relation("PersonalObjectiveUsers", fields: [objectiveId], references: [id], onDelete: Cascade)

  @@id([userId, objectiveId])
  @@map("user_personal_objective")
}

model Tip {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  title       String
  description String
  image       String
  order       Int?      @map("display_order")

  @@index([order])
  @@map("tip")
}

// ============================================
// SOCIAL.PLUS INTEGRATION MODELS
// ============================================

model Community {
  id                    String    @id @default(uuid())
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  deletedAt             DateTime? @map("deleted_at")
  name                  String
  description           String?
  type                  String // public, private, official, unofficial
  avatar                String?
  socialPlusCommunityId String?   @unique @map("social_plus_community_id")
  createdBy             String    @map("created_by") // userId

  // Relations
  creator User              @relation("UserCreatedCommunities", fields: [createdBy], references: [id])
  members CommunityMember[] @relation("CommunityMembers")

  @@index([socialPlusCommunityId])
  @@index([createdBy])
  @@index([type])
  @@map("community")
}

model CommunityMember {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  userId      String    @map("user_id")
  communityId String    @map("community_id")
  role        String    @default("member") // member, admin, moderator

  // Relations
  user      User      @relation("UserCommunities", fields: [userId], references: [id], onDelete: Cascade)
  community Community @relation("CommunityMembers", fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@index([userId])
  @@index([communityId])
  @@map("community_member")
}

// ============================================
// E-COMMERCE MODELS - Product and Order Management
// ============================================

model Product {
  id              String    @id @default(uuid())
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")
  name            String
  description     String?
  sku             String?   @unique
  price           Decimal   @db.Decimal(10, 2)
  cost            Decimal?  @db.Decimal(10, 2)
  quantity        Int       @default(0) // Available stock
  image           String?
  category        String?
  brand           String?
  status          String    @default("active") // active, inactive, out_of_stock
  weight          Decimal?  @db.Decimal(10, 3) // in kg
  dimensions      String? // format: "LxHxW" (length x height x width)
  
  // Relations
  orderItems      OrderItem[]  @relation("ProductOrderItems")
  ads             Ad[]         @relation("ProductAds")

  @@index([sku])
  @@index([name])
  @@index([category])
  @@index([status])
  @@index([quantity])
  @@map("product")
}

model Order {
  id              String      @id @default(uuid())
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  deletedAt       DateTime?   @map("deleted_at")
  userId          String      @map("user_id")
  status          String      @default("pending") // pending, processing, shipped, delivered, cancelled
  total           Decimal     @db.Decimal(10, 2)
  subtotal        Decimal     @db.Decimal(10, 2)
  shippingCost    Decimal     @default(0) @db.Decimal(10, 2) @map("shipping_cost")
  tax             Decimal     @default(0) @db.Decimal(10, 2)
  shippingAddress String?     @map("shipping_address")
  billingAddress  String?     @map("billing_address")
  notes           String?
  paymentMethod   String?     @map("payment_method")
  paymentStatus   String      @default("pending") @map("payment_status") // pending, paid, failed, refunded
  trackingNumber  String?     @map("tracking_number")
  
  // Relations
  user      User        @relation("UserOrders", fields: [userId], references: [id], onDelete: Cascade)
  items     OrderItem[] @relation("OrderItems")

  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("order")
}

model OrderItem {
  id            String    @id @default(uuid())
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")
  orderId       String    @map("order_id")
  productId     String    @map("product_id")
  quantity      Int
  unitPrice     Decimal   @db.Decimal(10, 2) @map("unit_price") // Price at time of sale
  discount      Decimal   @default(0) @db.Decimal(10, 2)
  total         Decimal   @db.Decimal(10, 2)
  
  // Relations
  order   Order   @relation("OrderItems", fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation("ProductOrderItems", fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_item")
}

model Advertiser {
  id              String    @id @default(uuid())
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")
  userId          String    @unique @map("user_id") // A user can be an advertiser
  name            String
  description     String?
  logo            String?
  contactEmail    String?   @map("contact_email")
  contactPhone    String?   @map("contact_phone")
  website         String?
  status          String    @default("active") // active, inactive, suspended
  
  // Relations
  user       User       @relation("UserAdvertiser", fields: [userId], references: [id], onDelete: Cascade)
  ads        Ad[]       @relation("AdvertiserAds")

  @@index([userId])
  @@index([status])
  @@map("advertiser")
}

model Ad {
  id              String    @id @default(uuid())
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")
  advertiserId    String    @map("advertiser_id")
  productId       String    @map("product_id")
  title           String
  description     String?
  image           String?
  startDate       DateTime? @map("start_date")
  endDate         DateTime? @map("end_date")
  status          String    @default("active") // active, inactive, expired
  targetAudience  String?   @map("target_audience")
  budget          Decimal?  @db.Decimal(10, 2)
  externalUrl     String?   @map("external_url") // External URL for the ad (e.g., Amazon product link)
  category        String?   // amazon product, physical product, program
  
  // Relations
  advertiser Advertiser @relation("AdvertiserAds", fields: [advertiserId], references: [id], onDelete: Cascade)
  product    Product    @relation("ProductAds", fields: [productId], references: [id], onDelete: Cascade)

  @@index([advertiserId])
  @@index([productId])
  @@index([status])
  @@index([category])
  @@index([startDate])
  @@index([endDate])
  @@map("ad")
}
